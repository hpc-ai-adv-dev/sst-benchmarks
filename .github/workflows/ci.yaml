name: CI

on:
  pull_request:

jobs:
  # Build jobs - create libraries once for each SST version and share as artifacts
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix: &test-matrix
        sst_version:
          - { tag: "15.0.0", image: "arezaiihpe/sst-core:15.0.0" }
          - { tag: "15.1.0", image: "arezaiihpe/sst-core:15.1.0" }
          - { tag: "master", image: "ghcr.io/hpc-ai-adv-dev/sst-core:master-latest" }
        component: ["gameoflife", "pingpong", "phold"]
    container:
      image: ${{ matrix.sst_version.image }}

    steps:
    - uses: actions/checkout@v4

    - name: Build ${{ matrix.component }} library
      run: |
        cd ${{ matrix.component }}
        make

    - name: Upload ${{ matrix.component }} library
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.component }}-lib-${{ matrix.sst_version.tag }}
        path: ${{ matrix.component }}/lib*.so
        retention-days: 1

  # Test jobs - use pre-built libraries
  test:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix: *test-matrix
    container:
      image: ${{ matrix.sst_version.image }}

    steps:
    - uses: actions/checkout@v4

    - name: Download ${{ matrix.component }} library
      uses: actions/download-artifact@v4
      with:
        name: ${{ matrix.component }}-lib-${{ matrix.sst_version.tag }}
        path: ${{ matrix.component }}/

    - name: Run ${{ matrix.component }} test
      run: |
        cd ${{ matrix.component }}
        case "${{ matrix.component }}" in
          "gameoflife")
            sst-register gol gol_LIBDIR=$(pwd)
            sst gol.py -- --verbose --seed 42 > gol_sim.out
            diff ../.github/workflows/gol.good ./gol_sim.out
            ;;
          "pingpong")
            sst-register pingpong pingpong_LIBDIR=$(pwd)
            sst pingpong.py -- --corners --verbose > pingpong_sim.out
            diff ../.github/workflows/pingpong.good ./pingpong_sim.out
            ;;
          "phold")
            sst-register phold phold_LIBDIR=$(pwd)
            sst phold_dist.py -- --verbose 1 > phold_sim.out 2>&1
            diff ../.github/workflows/phold.good ./phold_sim.out
            ;;
        esac

  # Checkpoint testing jobs - run with checkpoint enabled
  checkpoint:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix: *test-matrix
    container:
      image: ${{ matrix.sst_version.image }}

    steps:
    - uses: actions/checkout@v4

    - name: Download ${{ matrix.component }} library
      uses: actions/download-artifact@v4
      with:
        name: ${{ matrix.component }}-lib-${{ matrix.sst_version.tag }}
        path: ${{ matrix.component }}/

    - name: Run ${{ matrix.component }} with checkpoint enabled
      run: |
        cd ${{ matrix.component }}
        case "${{ matrix.component }}" in
          "gameoflife")
            sst-register gol gol_LIBDIR=$(pwd)
            sst --checkpoint-sim-period=1.5s gol.py -- --verbose --seed 42 2>&1 | grep -v "Real CPU time" > gol_checkpoint.out
            diff ../.github/workflows/gol_checkpoint.good ./gol_checkpoint.out
            ;;
          "pingpong")
            sst-register pingpong pingpong_LIBDIR=$(pwd)
            sst --checkpoint-sim-period=50ps pingpong.py -- --corners --verbose 2>&1 | grep -v "Real CPU time" > pingpong_checkpoint.out
            diff ../.github/workflows/pingpong_checkpoint.good ./pingpong_checkpoint.out
            ;;
          "phold")
            sst-register phold phold_LIBDIR=$(pwd)
            sst --checkpoint-sim-period=250ns phold_dist.py -- --verbose 1 2>&1 | grep -v "Real CPU time" > phold_checkpoint.out
            diff ../.github/workflows/phold_checkpoint.good ./phold_checkpoint.out
            ;;
        esac
        # Verify checkpoint files were created
        ls -la checkpoint_*/ || echo "No checkpoint directory found"

    - name: Upload checkpoint artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.component }}-checkpoint-${{ matrix.sst_version.tag }}
        path: ${{ matrix.component }}/checkpoint/
        retention-days: 1

  # Checkpoint restore testing jobs - restore from checkpoint
  restore:
    runs-on: ubuntu-latest
    needs: checkpoint
    strategy:
      matrix: *test-matrix
    container:
      image: ${{ matrix.sst_version.image }}

    steps:
    - uses: actions/checkout@v4

    - name: Download ${{ matrix.component }} library
      uses: actions/download-artifact@v4
      with:
        name: ${{ matrix.component }}-lib-${{ matrix.sst_version.tag }}
        path: ${{ matrix.component }}/

    - name: Download checkpoint artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ matrix.component }}-checkpoint-${{ matrix.sst_version.tag }}
        path: ${{ matrix.component }}/checkpoint/

    - name: Restore ${{ matrix.component }} from checkpoint
      run: |
        cd ${{ matrix.component }}
        case "${{ matrix.component }}" in
          "gameoflife")
            sst-register gol gol_LIBDIR=$(pwd)
            CHECKPOINT_FILE=$(find checkpoint -name "*.sstcpt" | sort | head -1)
            echo "Restoring from: $CHECKPOINT_FILE"
            sst --load-checkpoint "$CHECKPOINT_FILE" > gol_restore.out 2>&1
            diff ../.github/workflows/gol_restore.good ./gol_restore.out
            ;;
          "pingpong")
            sst-register pingpong pingpong_LIBDIR=$(pwd)
            CHECKPOINT_FILE=$(find checkpoint -name "*.sstcpt" | sort | head -1)
            echo "Restoring from: $CHECKPOINT_FILE"
            sst --load-checkpoint "$CHECKPOINT_FILE" > pingpong_restore.out 2>&1
            diff ../.github/workflows/pingpong_restore.good ./pingpong_restore.out
            ;;
          "phold")
            sst-register phold phold_LIBDIR=$(pwd)
            CHECKPOINT_FILE=$(find checkpoint -name "*.sstcpt" | sort | head -1)
            echo "Restoring from: $CHECKPOINT_FILE"
            sst --load-checkpoint "$CHECKPOINT_FILE" > phold_restore.out 2>&1
            diff ../.github/workflows/phold_restore.good ./phold_restore.out
            ;;
        esac
        # Verify simulation completed
        grep -q "Simulation is complete" *_restore.out
